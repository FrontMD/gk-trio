// Страница контакты
function contactsController() {

    const contactsBlock = document.querySelector('[data-js="contactsBlock"]')
    
    if(!contactsBlock) return

    // Инициализация карты
    
    const mapContainer = contactsBlock.querySelector('[data-js="contactsMap"]')
    let mapPlacemarks = [...contactsBlock.querySelectorAll('[data-js="contactsTabsTab"]')]
    let map = false

    ymaps.ready(function () {

        let center = mapPlacemarks.length > 0 ? mapPlacemarks[0].dataset.coords.replace(/\s/g,"").split(",") : [52.578441, 39.607545]
        let windowWidth = window.innerWidth
        let zoom = 12;

        if(windowWidth < 768) {
            zoom = 12
        }
    
        map = new ymaps.Map(mapContainer, {
            center: center,
            zoom: zoom,
            controls: []
        });

        let myGeoObjects = []
        
        mapPlacemarks.forEach(placemark => {
            
            let currentPlacemark = new ymaps.Placemark(
                placemark.dataset.coords.replace(/\s/g,"").split(","),
                {},
                {
                    openEmptyBalloon: false,
                    iconLayout: 'default#image',
                    iconImageHref: "data:image/svg+xml,%3Csvg width='45' height='45' viewBox='0 0 45 45' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M28.0207 22.5086C28.8318 22.5086 29.4955 21.8333 29.4955 21.0081V19.5076C29.4955 18.6824 28.8318 18.0072 28.0207 18.0072C27.2096 18.0072 26.5459 18.6824 26.5459 19.5076V21.0081C26.5459 21.8333 27.2096 22.5086 28.0207 22.5086ZM7.24114 6.75365C8.96662 6.75365 10.4414 7.92401 10.8986 9.52951C10.3972 10.0397 9.98422 10.6249 9.64502 11.255H7.5066C6.49356 11.255 5.52201 10.8456 4.80569 10.1168C4.08936 9.388 3.68693 8.39953 3.68693 7.36884V7.06875C3.68693 6.88869 3.81966 6.75365 3.99664 6.75365H7.24114ZM19.1721 30.0109C19.1721 30.4088 19.0167 30.7905 18.7401 31.0719C18.4635 31.3533 18.0884 31.5114 17.6973 31.5114C17.3062 31.5114 16.931 31.3533 16.6545 31.0719C16.3779 30.7905 16.2225 30.4088 16.2225 30.0109C16.2225 29.6129 16.3779 29.2313 16.6545 28.9499C16.931 28.6685 17.3062 28.5104 17.6973 28.5104C18.0884 28.5104 18.4635 28.6685 18.7401 28.9499C19.0167 29.2313 19.1721 29.6129 19.1721 30.0109ZM26.5459 31.5114C26.9371 31.5114 27.3122 31.3533 27.5888 31.0719C27.8653 30.7905 28.0207 30.4088 28.0207 30.0109C28.0207 29.6129 27.8653 29.2313 27.5888 28.9499C27.3122 28.6685 26.9371 28.5104 26.5459 28.5104C26.1548 28.5104 25.7797 28.6685 25.5031 28.9499C25.2265 29.2313 25.0712 29.6129 25.0712 30.0109C25.0712 30.4088 25.2265 30.7905 25.5031 31.0719C25.7797 31.3533 26.1548 31.5114 26.5459 31.5114Z' fill='%23111111'/%3E%3Cpath d='M17.917 0.147088L17.9023 0.15459C17.4613 0.333146 17.0086 0.559716 16.5602 0.874814C14.6991 2.1277 13.5222 3.94777 13.3098 6.07994C12.628 5.12812 11.7352 4.35338 10.7037 3.81865C9.67232 3.28392 8.53147 3.00429 7.37387 3.00248H2.21216C1.62546 3.00248 1.06279 3.2396 0.647927 3.66169C0.233066 4.08378 0 4.65626 0 5.25318V7.50388C0 9.49362 0.776887 11.4019 2.15976 12.8088C2.84448 13.5055 3.65737 14.0581 4.55201 14.4351C5.44665 14.8122 6.40552 15.0062 7.37387 15.0062V27.1255C6.43851 28.6206 5.92808 30.35 5.8991 32.1221C5.86615 34.6672 6.81248 37.1246 8.53604 38.9696C10.2596 40.8146 12.6238 41.9009 15.1238 41.9966C16.0341 42.9472 17.1223 43.7026 18.3241 44.2184C19.526 44.7343 20.8172 45 22.1216 45C23.426 45 24.7172 44.7343 25.9191 44.2184C27.1209 43.7026 28.2091 42.9472 29.1194 41.9966C31.6194 41.9009 33.9836 40.8146 35.7072 38.9696C37.4307 37.1246 38.3771 34.6672 38.3441 32.1221C38.3162 30.3479 37.8057 28.6164 36.8693 27.1195V15.0062C38.825 15.0062 40.7006 14.2158 42.0835 12.8088C43.4663 11.4019 44.2432 9.49362 44.2432 7.50388V5.25318C44.2432 4.65626 44.0101 4.08378 43.5953 3.66169C43.1804 3.2396 42.6178 3.00248 42.0311 3.00248H36.8693C35.1323 3.00346 33.4519 3.63078 32.1265 4.77303C31.6413 3.21254 30.6134 1.85462 29.1563 0.874814C28.7373 0.584535 28.2876 0.342952 27.8157 0.15459L27.801 0.147088C26.0652 -0.535625 24.5034 1.28894 25.2319 2.93045L25.2363 2.94246L25.2422 2.95446C25.7112 3.95978 25.8071 4.96959 25.4575 6.00341H20.5289C20.4855 5.78135 20.4476 5.55821 20.4153 5.3342C20.3423 4.85626 20.3092 4.37288 20.3165 3.88925C20.3312 3.41961 20.402 3.11651 20.4772 2.95446L20.4831 2.94246L20.4876 2.93045C21.2161 1.28894 19.6528 -0.535625 17.917 0.147088ZM15.4851 9.00435H23.5964L25.6316 11.075C26.391 11.8466 27.2925 12.4585 28.2844 12.8756C29.2764 13.2926 30.3394 13.5068 31.4127 13.5058H33.8711L33.8888 13.6708C33.9095 13.8659 33.9198 14.0609 33.9198 14.256V26.2507C32.3619 25.2664 30.5624 24.75 28.7286 24.7608H20.6468V22.6886C20.6468 18.8174 18.6411 14.9012 15.4851 12.7555C13.9101 11.6827 10.3234 12.0053 10.3234 12.0053H7.37387C6.20047 12.0053 5.07512 11.531 4.2454 10.6869C3.41568 9.84268 2.94955 8.69773 2.94955 7.50388V6.00341H7.37387C8.2332 6.00297 9.07407 6.25715 9.79376 6.73491C10.5134 7.21267 11.0808 7.89333 11.4265 8.69375L12.0238 10.0772L13.3791 9.45899C14.0428 9.1589 14.7595 9.00285 15.4851 9.00435ZM15.4851 39.0137C14.6052 39.0138 13.7341 38.8359 12.9224 38.4903C12.1107 38.1447 11.3747 37.6383 10.7571 37.0006C10.1396 36.363 9.65281 35.6067 9.32517 34.7759C8.99753 33.945 8.83554 33.0562 8.84864 32.1611C8.86632 30.8115 9.2865 29.4991 10.0535 28.3979L10.1568 28.2493C11.5224 27.007 13.4603 26.2237 15.6341 26.2612H28.7301C30.8567 26.2552 32.7488 27.0295 34.0879 28.2463L34.1897 28.3934C34.9566 29.4962 35.3783 30.8091 35.3946 32.1611C35.4077 33.0562 35.2457 33.945 34.918 34.7759C34.5904 35.6067 34.1036 36.363 33.4861 37.0006C32.8685 37.6383 32.1325 38.1447 31.3208 38.4903C30.5091 38.8359 29.638 39.0138 28.7581 39.0137H15.4851ZM17.8861 40.5142H26.3454C25.3514 41.3065 24.1617 41.8042 22.9074 41.9525C21.6531 42.1007 20.383 41.8938 19.2369 41.3544C18.7566 41.1278 18.3033 40.8458 17.8861 40.5142ZM36.8693 12.0053H34.9344C34.836 11.7491 34.7237 11.4987 34.5982 11.255H36.7366C37.7496 11.255 38.7212 10.8456 39.4375 10.1168C40.1539 9.388 40.5563 8.39952 40.5563 7.36884V7.06874C40.5563 6.88869 40.4235 6.75365 40.2466 6.75365H37.0021C35.2766 6.75365 33.8018 7.92401 33.3446 9.52951C33.3584 9.54352 33.3702 9.55802 33.38 9.57302C33.1641 9.35424 32.9351 9.14928 32.6943 8.95933L32.8093 8.68925C33.1562 7.8885 33.725 7.20799 34.4461 6.73097C35.1671 6.25396 36.0092 6.00113 36.8693 6.00341H41.2937V7.50388C41.2937 8.69773 40.8275 9.84268 39.9978 10.6869C39.1681 11.531 38.0427 12.0053 36.8693 12.0053ZM14.7477 21.0081V19.5076C14.7477 18.6824 15.4114 18.0072 16.2225 18.0072C17.0336 18.0072 17.6973 18.6824 17.6973 19.5076V21.0081C17.6973 21.8333 17.0336 22.5086 16.2225 22.5086C15.4114 22.5086 14.7477 21.8333 14.7477 21.0081Z' fill='%23111111'/%3E%3C/svg%3E%0A",
                    iconImageSize: [30, 30],
                    iconImageOffset: [-15, -15],
                }
            );

            myGeoObjects.push(currentPlacemark)
            
        });

        var clusterer = new ymaps.Clusterer({
            gridSize: 120,
            preset: 'islands#redClusterIcons'
        });

        clusterer.add(myGeoObjects);

        map.geoObjects.add(clusterer);


    });

    // Работа табов
    const tabs = contactsBlock.querySelectorAll('[data-js="contactsTabsTab"]')
    const infoItems = contactsBlock.querySelectorAll('[data-js="contactsInfoItem"]')

    if(tabs.length > 0) {
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                contactsSwitch(tab)
            })
        })
    }

    function contactsSwitch(tab) {

        map.setCenter(getCoordsArr(tab.dataset.coords))

        tabs.forEach(item => {
            item.classList.remove('active')
        })

        if(tab.dataset.js == 'contactsTabsTab') {
            tab.classList.add('active')
        } else {
            selectBlock.classList.add('active')
        }

        infoItems.forEach((item, index) => {
            item.classList.remove('active')

            if(index == tab.dataset.id) {
                item.classList.add('active')
            }
        })
    }

    function getCoordsArr(coords) {
        return coords.replace(/\s/g, '').split(',')
    }
}